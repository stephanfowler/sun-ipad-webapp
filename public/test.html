<html>

<head>
	<style type="text/css">
		body {
			font-family: arial, sans-serif;
		}
		a {
			text-decoration: none;
			color: #ffd32e;		
		}
		.user {
			color: #999;
		}
		#messages {
			border-top: 1px dashed #ccc;
		}
		#messages div {
			border-bottom: 1px dashed #ccc;
			padding: 4px;		
		}
	</style>

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script> 
	<script type="text/javascript" src="http://localhost:8080/nowjs/now.js"></script>
	<script type='text/javascript' src="http://localhost/common/js/knockout-2.0.0rc.js"></script>
	
	<script type="text/javascript">

		$(document).ready(function(){

			var msg = function( name, message ) {
				this.name = ( name == now.name ? 'Me' : name); 
				this.message = message;
				this.ditch = function() { viewModel.messages.remove(this) };
			}	
	
			var viewModel = { 

				user : ko.observable(),
				
				setUser : function() {
					now.name = $("#username-input").val();
					this.user( now.name );
					now.distributeMessage( '', true );
					$("#text-input").focus();
				},

				messages : ko.observableArray(),
	
				addMessage : function ( name, message ) {
			  	this.messages.unshift( new msg( name, message ) );
			  	if ( this.messages().length > 10 ) {
			  		this.messages.pop();
			  	}
				},
			
				sendMessage : function(){
					if ( document.getElementById("text-input").value ) {
					  now.distributeMessage( $("#text-input").val() );
						$("#text-input").val("").focus();
					}
				}
		  }
						
			ko.applyBindings( viewModel );


			now.ready( function() {

				now.receiveMessage = function(name, message){				
				  viewModel.addMessage( name, message );
				}
	
				now.receiveHistory = function( msgHistory ){				
					for ( var m in msgHistory ) {
				  	viewModel.addMessage( msgHistory[m].name, msgHistory[m].message );
				 	}
				}
	
				now.sendHistory();
			}); 

			$("#username-input").focus();


		});
	</script>
	
</head>
<body>

		<!-- ko ifnot: user -->
		<form data-bind="submit: setUser">
			<div>Join as: </div> 
			<input type="text" id="username-input" />
			<input type="submit" value="Join" />
		</form>
		<!-- /ko -->
		
		<!-- ko if: user -->
		<form data-bind="submit: sendMessage">
			<div>Joined as <span data-bind="text: user" class="user"></span></div>
			<input type="text" id="text-input">
			<input type="submit" value="Post" />
		</form>
		<!-- /ko -->

		<div data-bind="foreach: messages" id="messages">
			<div>
				<a href="#" data-bind="click: ditch">x</a>
				<span data-bind="text: name" class="user"></span> 
				<span data-bind="if: message"> : <span data-bind="text: message"></span></span>
			</div>
		</div>
		
</body>
</html>

